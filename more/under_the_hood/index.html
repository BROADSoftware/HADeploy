<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Under the hood - HADeploy</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">HADeploy</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li >
                        <a href="../../installation/">Installation</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../getting_started/first_step/">First step</a>
</li>
                            
<li >
    <a href="../../getting_started/next_step/">Next step</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Plugins reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Core</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/core/encrypted_vars/">encrypted_vars</a>
</li>
            
<li >
    <a href="../../plugins_reference/core/excluded_scopes/">excluded_scopes</a>
</li>
            
<li >
    <a href="../../plugins_reference/core/include/">include</a>
</li>
            
<li >
    <a href="../../plugins_reference/core/included_scopes/">included_scopes</a>
</li>
            
<li >
    <a href="../../plugins_reference/core/vars/">vars</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/ansible/ansible_overview/">Overview</a>
</li>
            
<li >
    <a href="../../plugins_reference/ansible/ansible_playbooks/">ansible_playbooks</a>
</li>
            
<li >
    <a href="../../plugins_reference/ansible/playbooks_folders/">playbooks_folders</a>
</li>
            
<li >
    <a href="../../plugins_reference/ansible/roles_folders/">roles_folders</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible_inventories</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/ansible_inventories/ansible_inventories/">ansible_inventories</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Elasticsearch</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/elastic/elasticsearch_indices/">elasticsearch_indices</a>
</li>
            
<li >
    <a href="../../plugins_reference/elastic/elasticsearch_servers/">elasticsearch_servers</a>
</li>
            
<li >
    <a href="../../plugins_reference/elastic/elasticsearch_templates/">elasticsearch_templates</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Files</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/files/files/">files</a>
</li>
            
<li >
    <a href="../../plugins_reference/files/folders/">folders</a>
</li>
            
<li >
    <a href="../../plugins_reference/files/maven_repositories/">maven_repositories</a>
</li>
            
<li >
    <a href="../../plugins_reference/files/local_files_folders/">local_files_folders</a>
</li>
            
<li >
    <a href="../../plugins_reference/files/local_templates_folders/">local_templates_folders</a>
</li>
            
<li >
    <a href="../../plugins_reference/files/trees/">trees</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">HBase</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/hbase/hbase_datasets/">hbase_datasets</a>
</li>
            
<li >
    <a href="../../plugins_reference/hbase/hbase_namespaces/">hbase_namespaces</a>
</li>
            
<li >
    <a href="../../plugins_reference/hbase/hbase_relay/">hbase_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/hbase/hbase_tables/">hbase_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hdfs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/hdfs/hdfs_relay/">hdfs_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/hdfs/source_host_credentials/">source_host_credentials</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hive</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/hive/hive_databases/">hive_databases</a>
</li>
            
<li >
    <a href="../../plugins_reference/hive/hive_relay/">hive_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/hive/hive_tables/">hive_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Inventory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/inventory/exit_on_fail/">exit_on_fail</a>
</li>
            
<li >
    <a href="../../plugins_reference/inventory/hosts/">hosts</a>
</li>
            
<li >
    <a href="../../plugins_reference/inventory/host_groups/">host_groups</a>
</li>
            
<li >
    <a href="../../plugins_reference/inventory/host_group_overrides/">host_group_overrides</a>
</li>
            
<li >
    <a href="../../plugins_reference/inventory/host_overrides/">host_overrides</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Kafka</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/kafka/kafka_relay/">kafka_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/kafka/kafka_topics/">kafka_topic</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ranger</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/ranger/hbase_ranger_policies/">hbase_ranger_policies</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/hdfs_ranger_policies/">hdfs_ranger_policies</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/hive_ranger_policies/">hive_ranger_policies</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/kafka_ranger_policies/">kafka_ranger_policies</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/ranger_relay/">ranger_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/storm_ranger_policies/">storm_ranger_policies</a>
</li>
            
<li >
    <a href="../../plugins_reference/ranger/yarn_ranger_policies/">yarn_ranger_policies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Storm</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/storm/storm_overview/">storm_overview</a>
</li>
            
<li >
    <a href="../../plugins_reference/storm/storm_relay/">storm_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/storm/storm_topologies/">storm_topologies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Systemd</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/systemd/systemd_units/">systemd_units</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Supervisors</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/supervisor/supervisor_overview/">Overview</a>
</li>
            
<li >
    <a href="../../plugins_reference/supervisor/supervisors/">supervisors</a>
</li>
            
<li >
    <a href="../../plugins_reference/supervisor/supervisor_groups/">supervisor_groups</a>
</li>
            
<li >
    <a href="../../plugins_reference/supervisor/supervisor_programs/">supervisor_programs</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Users</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/users/groups/">groups</a>
</li>
            
<li >
    <a href="../../plugins_reference/users/users/">users</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Yarn</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../plugins_reference/yarn/yarn_overview/">yarn_overview</a>
</li>
            
<li >
    <a href="../../plugins_reference/yarn/yarn_relay/">yarn_relay</a>
</li>
            
<li >
    <a href="../../plugins_reference/yarn/yarn_services/">yarn_service</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../conditional_deployment/">Conditional deployment</a>
</li>
                            
<li class="active">
    <a href="./">Under the hood</a>
</li>
                            
<li >
    <a href="../execution_order/">Execution order</a>
</li>
                            
<li >
    <a href="../altering_scope/">Altering scope</a>
</li>
                            
<li >
    <a href="../secured_cluster/">Secured cluster</a>
</li>
                            
<li >
    <a href="../yaml_tricks/">YAML tricks</a>
</li>
                            
<li >
    <a href="../release_notes/">Release notes</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../conditional_deployment/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../execution_order/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#under-the-hood">Under the hood</a></li>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#variables">Variables</a></li>
            <li><a href="#the-working-folder">The working folder</a></li>
            <li><a href="#plugins">Plugins</a></li>
            <li><a href="#embedded-ansible-roles">Embedded Ansible roles</a></li>
            <li><a href="#embedded-helpers">Embedded Helpers</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="under-the-hood">Under the hood</h1>
<h2 id="overview">Overview</h2>
<p>As stated in the installation instruction, HADeploy use Ansible under the hood to perform operation on the remote hosts. As such Ansible is defined as a dependency for HADeploy installation.</p>
<p>The main steps of an HADeploy run are the following:</p>
<ol>
<li>
<p>Load the application description by appending all <code>--src</code> files provided on the command line to build a single deployment file.</p>
</li>
<li>
<p>Check syntax of this deployment file, based on a YAML schema.</p>
</li>
<li>
<p>Build a data model in memory representing this file content.</p>
</li>
<li>
<p>For all objects, Check <code>when:</code> clause and remove it if <code>False</code>.</p>
</li>
<li>
<p>Check this data model for consistency, enrich it, or transform some data to ease the next stages.</p>
</li>
<li>
<p>Generate a Jinja2 template by concatenating all template snippets provided by the plugins.</p>
</li>
<li>
<p>Render this template with the model to generate an Ansible playbook</p>
</li>
<li>
<p>Launch Ansible on this playbook.</p>
</li>
</ol>
<h2 id="variables">Variables</h2>
<p>When using HADeploy in an advanced way (i.e using the <code>ansible</code> module, or developing your own plugin), you may be disturbed by different variable notation. 
There is in fact 3 kinds of variables involved in HADeploy</p>
<h4 id="my_variable"><code>${my_variable}</code></h4>
<p>Or <code>&lt;&lt;my_variable&gt;&gt;</code></p>
<p>This is the only variable notation you should be aware of for standard usage of HADeploy.</p>
<p>Such variables are resolved during step 1 (Building of the deployment file).</p>
<p>Refer to <a href="../../plugins_reference/core/vars/#alternate-notation">alternate notation</a> for the motivation of using <code>&lt;&lt;my_variable&gt;&gt;</code>.</p>
<h4 id="my_variable_1"><code>{{{my_variable}}}</code></h4>
<p>This is the variable notation used during the rendering of step 6. This will allow all snippets provided by the plugin to access variables of the model.</p>
<h4 id="my_variable_2"><code>{{my_variable}}</code></h4>
<p>This is the standard variable notation used by Ansible. HADeploy will not resolve such variables, passing them as is to Ansible playbook. So they will be resolved by Ansible in step 7.</p>
<p>This form need generaly to be quoted (<code>"{{my_variable}}"</code>). It must also be used for <a href="../../plugins_reference/core/encrypted_vars">encrypted values</a></p>
<h3 id="variable-relationship">Variable relationship</h3>
<p>Although this variables act at different level, there is some mechanism to propagate user's value (The one with ${..} notation) to lower level.</p>
<ul>
<li>
<p>They are copied in the data model built in step 3, under the token <code>src.vars</code>. So, the variable <code>${my_variable}</code>can be accessed by <code>{{{src.vars.my_variable}}}</code>by a plugin playbook snippet.</p>
</li>
<li>
<p>In the Ansible context, a <code>group_vars/all</code> file is generated, containing a line as <code>my_variable: my_value</code> for each user's variable. So, all the user's variable will be directly accessible by Ansible, in step 7.</p>
</li>
</ul>
<h2 id="the-working-folder">The working folder</h2>
<p>In case of problem, it could be useful to have a look on the generated Ansible playbook.
This playbook is generated in a temporary folder, called the <code>working folder</code>. It is named as the action provided as parameter.</p>
<p>This folder is automatically created in <code>/tmp</code>, under a random name. 
To ease debugging, one can force this working folder to a specific location, using the <code>--workingFolder</code> command line option.</p>
<blockquote>
<p>Warning: In such case, the full content of the working folder will be deleted on each run...</p>
</blockquote>
<p>But, this working folder not only contains the playbook. Here is a brief description of the files you may found in it:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ansible.cfg<br>inventory<br>group_vars folder</td>
<td>HAdeploy create a complete Ansible context to run Ansible inside.</td>
</tr>
<tr>
<td><code>&lt;action&gt;</code>.yml.jj2</td>
<td>This is the Jinja2 source template, result of step 5 above, which will be merged with the data model to produce the file below.</td>
</tr>
<tr>
<td><code>&lt;action&gt;</code>.yml</td>
<td>The playbook for targeted action, generated on step 6. i.e <code>deploy.yml</code> or <code>remove.yml</code>.</td>
</tr>
<tr>
<td>model_src.json</td>
<td>This is the part of the data model built from the sources file.</td>
</tr>
<tr>
<td>model_data.json</td>
<td>This is a the part of the data model where HADeploy store some intermediate structure.</td>
</tr>
<tr>
<td>model_helper.json</td>
<td>This is a part of the data model hosting some configuration information.</td>
</tr>
<tr>
<td>schema.yml</td>
<td>This is the YAML schema used to validate source input files. Will use <a href="https://github.com/Grokzen/pykwalify">pykwalify</a> tool for validation.</td>
</tr>
<tr>
<td>desc_xxxx.yml.j2</td>
<td>Some helper files, specific to some plugins.</td>
</tr>
</tbody>
</table>
<p>Note: If you launch HADeploy with <code>--action none</code> then it will generate ansible playbooks for all action it is aware off. But, it will not launch ansible. 
This is intended to validate description for all action.</p>
<h2 id="plugins">Plugins</h2>
<p>A plugin is a component which may be involved in all phases described at the befinning of this page. It is typically made of:</p>
<ul>
<li>
<p>A partial schema. All plugin's YAML schema parts will be merged to provide the overall schema against which the deployment file will be validated.</p>
</li>
<li>
<p>Some Python code called to check and enrich the model. This code must include a subclass of the <code>Plugin</code> class, to handle plugin properties and lifecycle.</p>
</li>
<li>
<p>Several playbook snippet. Typically, one per supported action. For a given action, all plugin plabook's snippets will be concatenated to build the target playbook. These snippets are Jinja2 templates which will be merged with the data model.</p>
</li>
</ul>
<p>All theses are optional. A plugin can also host:</p>
<ul>
<li>
<p>Ansible roles or modules.</p>
</li>
<li>
<p>One or more helper. An helper is a specific program designed to manage services which offer only a Java API.</p>
</li>
</ul>
<p>Currently, HADeploy is provided with the following internal plugin:</p>
<ul>
<li><code>inventory</code> for target hosts management.</li>
<li><code>ansible_inventories</code> for direct integration of an Ansible inventories.</li>
<li><code>users</code> for management of local users and groups. </li>
<li><code>files</code> for base file management.</li>
<li><code>hdfs</code> which extends the previous one for HDFS accesses.</li>
<li><code>hbase</code></li>
<li><code>hive</code></li>
<li><code>kafka</code></li>
<li><code>ansible</code></li>
<li><code>ranger</code></li>
</ul>
<h2 id="embedded-ansible-roles">Embedded Ansible roles</h2>
<ul>
<li>
<p>For HDFS access, HADeploy embeds the <a href="https://github.com/BROADSoftware/hdfs_modules">hdfs_modules</a> Ansible modules in the HDFS plugin</p>
</li>
<li>
<p>For Apache Ranger policy handling, HADeploy embeds the <a href="https://github.com/BROADSoftware/ranger_modules">ranger_modules</a> Ansible modules in the Ranger plugin</p>
</li>
<li>
<p>For Storm topologies lifecycle handling, HADeploy embeds the <a href="https://github.com/BROADSoftware/storm_modules">storm_modules</a> Ansible modules in the Elasticsearch plugin</p>
</li>
<li>
<p>For Elasticsearch indices and templates managment, HADeploy embeds the <a href="https://github.com/BROADSoftware/elastic_modules">elastic_modules</a> Ansible modules in the Elasticsearch plugin</p>
</li>
</ul>
<h2 id="embedded-helpers">Embedded Helpers</h2>
<h3 id="hive">Hive</h3>
<ul>
<li>For Hive based deployment, HADeploy embeds the <a href="https://github.com/BROADSoftware/jdchive">jdchive</a> tool.</li>
</ul>
<h3 id="hbase">HBase</h3>
<ul>
<li>
<p>For HBase based deployment, HADeploy embeds the <a href="https://github.com/BROADSoftware/jdchtable">jdchtable</a> tool.</p>
</li>
<li>
<p>For HBase dataset loading, HADeploy embeds the <a href="https://github.com/BROADSoftware/hbtools">hbload</a> tool.</p>
</li>
</ul>
<h3 id="kafka">Kafka</h3>
<ul>
<li>For Kafka based deployment, HADeploy embeds the <a href="https://github.com/Kappaware/jdctopic">jdctopic</a> tool.</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

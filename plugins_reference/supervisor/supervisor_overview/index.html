<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Overview - HADeploy</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../..">HADeploy</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                    <li >
                        <a href="../../../installation/">Installation</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../getting_started/first_step/">First step</a>
</li>
                            
<li >
    <a href="../../../getting_started/next_step/">Next step</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Plugins reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Core</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../core/encrypted_vars/">encrypted_vars</a>
</li>
            
<li >
    <a href="../../core/excluded_scopes/">excluded_scopes</a>
</li>
            
<li >
    <a href="../../core/include/">include</a>
</li>
            
<li >
    <a href="../../core/included_scopes/">included_scopes</a>
</li>
            
<li >
    <a href="../../core/vars/">vars</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ansible/ansible_overview/">Overview</a>
</li>
            
<li >
    <a href="../../ansible/ansible_playbooks/">ansible_playbooks</a>
</li>
            
<li >
    <a href="../../ansible/playbooks_folders/">playbooks_folders</a>
</li>
            
<li >
    <a href="../../ansible/roles_folders/">roles_folders</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible_inventories</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ansible_inventories/ansible_inventories/">ansible_inventories</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Elasticsearch</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../elastic/elasticsearch_indices/">elasticsearch_indices</a>
</li>
            
<li >
    <a href="../../elastic/elasticsearch_servers/">elasticsearch_servers</a>
</li>
            
<li >
    <a href="../../elastic/elasticsearch_templates/">elasticsearch_templates</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Files</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../files/files/">files</a>
</li>
            
<li >
    <a href="../../files/folders/">folders</a>
</li>
            
<li >
    <a href="../../files/maven_repositories/">maven_repositories</a>
</li>
            
<li >
    <a href="../../files/local_files_folders/">local_files_folders</a>
</li>
            
<li >
    <a href="../../files/local_templates_folders/">local_templates_folders</a>
</li>
            
<li >
    <a href="../../files/trees/">trees</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">HBase</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hbase/hbase_datasets/">hbase_datasets</a>
</li>
            
<li >
    <a href="../../hbase/hbase_namespaces/">hbase_namespaces</a>
</li>
            
<li >
    <a href="../../hbase/hbase_relay/">hbase_relay</a>
</li>
            
<li >
    <a href="../../hbase/hbase_tables/">hbase_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hdfs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hdfs/hdfs_relay/">hdfs_relay</a>
</li>
            
<li >
    <a href="../../hdfs/source_host_credentials/">source_host_credentials</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hive</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hive/hive_databases/">hive_databases</a>
</li>
            
<li >
    <a href="../../hive/hive_relay/">hive_relay</a>
</li>
            
<li >
    <a href="../../hive/hive_tables/">hive_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Inventory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../inventory/exit_on_fail/">exit_on_fail</a>
</li>
            
<li >
    <a href="../../inventory/hosts/">hosts</a>
</li>
            
<li >
    <a href="../../inventory/host_groups/">host_groups</a>
</li>
            
<li >
    <a href="../../inventory/host_group_overrides/">host_group_overrides</a>
</li>
            
<li >
    <a href="../../inventory/host_overrides/">host_overrides</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Kafka</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../kafka/kafka_relay/">kafka_relay</a>
</li>
            
<li >
    <a href="../../kafka/kafka_topics/">kafka_topic</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ranger</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ranger/hbase_ranger_policies/">hbase_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/hdfs_ranger_policies/">hdfs_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/hive_ranger_policies/">hive_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/kafka_ranger_policies/">kafka_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/ranger_relay/">ranger_relay</a>
</li>
            
<li >
    <a href="../../ranger/storm_ranger_policies/">storm_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/yarn_ranger_policies/">yarn_ranger_policies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Storm</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../storm/storm_overview/">storm_overview</a>
</li>
            
<li >
    <a href="../../storm/storm_relay/">storm_relay</a>
</li>
            
<li >
    <a href="../../storm/storm_topologies/">storm_topologies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Systemd</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../systemd/systemd_units/">systemd_units</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Supervisors</a>
    <ul class="dropdown-menu">
            
<li class="active">
    <a href="./">Overview</a>
</li>
            
<li >
    <a href="../supervisors/">supervisors</a>
</li>
            
<li >
    <a href="../supervisor_groups/">supervisor_groups</a>
</li>
            
<li >
    <a href="../supervisor_programs/">supervisor_programs</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Users</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../users/groups/">groups</a>
</li>
            
<li >
    <a href="../../users/users/">users</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Yarn</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../yarn/yarn_overview/">yarn_overview</a>
</li>
            
<li >
    <a href="../../yarn/yarn_relay/">yarn_relay</a>
</li>
            
<li >
    <a href="../../yarn/yarn_services/">yarn_service</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../more/conditional_deployment/">Conditional deployment</a>
</li>
                            
<li >
    <a href="../../../more/under_the_hood/">Under the hood</a>
</li>
                            
<li >
    <a href="../../../more/execution_order/">Execution order</a>
</li>
                            
<li >
    <a href="../../../more/altering_scope/">Altering scope</a>
</li>
                            
<li >
    <a href="../../../more/secured_cluster/">Secured cluster</a>
</li>
                            
<li >
    <a href="../../../more/yaml_tricks/">YAML tricks</a>
</li>
                            
<li >
    <a href="../../../more/release_notes/">Release notes</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../systemd/systemd_units/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../supervisors/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#supervisor-plugin-overview">Supervisor plugin: Overview</a></li>
            <li><a href="#a-simple-case">A simple case</a></li>
            <li><a href="#actions-stop-start-and-status">Actions stop, start and status</a></li>
            <li><a href="#web-interface">Web interface</a></li>
            <li><a href="#notifications-daemon-restart">Notifications: daemon restart</a></li>
            <li><a href="#non-root-deployment">Non-root deployment</a></li>
            <li><a href="#non-root-deployment-improved">Non-root deployment improved</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="supervisor-plugin-overview">Supervisor plugin: Overview</h1>
<p>Supervisor is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.</p>
<p>It shares some of the same goals of programs like systemd, but unlike this one, it is not meant to be run as a substitute for init as “process id 1”. 
Instead it is meant to be used to control processes related to a project or a customer, and is meant to start like any other program at boot time.</p>
<p>A supervisor instance is aimed to control several application programs. In practice, in most case, only one instance per application will be necessary.</p>
<p>This plugin allow both to create a <a href="../supervisors"><code>supervisor</code></a> instance and to define all programs this instance will have to manage, by defined  <a href="../supervisor_programs"><code>supervisor_programs</code></a></p>
<p>Creating a <code>supervisor</code> instance using this module require <code>root</code> access on the target host. 
But this instance is then delegated to a specific (typically non-priviledged) user (or technical account) which then will be able to perform any admin operation (Add/remove programs, start/stop, ...).</p>
<p>This module will also allow HADeploy to handle start and stop of the associated programs.</p>
<h2 id="a-simple-case">A simple case</h2>
<p>Let's begin with a simple example. In this example, we want to deploy a dameon on the two edge nodes of a cluster. </p>
<p>This deamon will run under the <code>tsup</code> technical account. We also want the supervisor to be manageable throught this account.</p>
<p>Here is a main application file, saved as <code>app.yml</code></p>
<pre><code class="yaml">hosts:
- { name: en1, ssh_host: en1.mycluster.com, ssh_user: root, ssh_private_key_file: keys/root_id }
- { name: en2, ssh_host: en2.mycluster.com, ssh_user: root, ssh_private_key_file: keys/root_id }

local_templates_folders:
- ./templates

users:
- login: tsup

folders:
- { scope: all, path: /opt/tsup, owner: tsup, group: tsup,  mode: &quot;0755&quot; }

supervisors:
- name: tsupv 
  scope: all
  user: tsup
  group: tsup

files:
- { scope: all, src: &quot;tmpl://program1.sh&quot;, dest_folder: /opt/tsup, owner: tsup, group: tsup, mode: &quot;0755&quot; }

supervisor_programs:
- name: program1
  supervisor: tsupv
  command: &quot;/bin/bash /opt/tsup/program1.sh&quot;
</code></pre>

<p>In this file we:</p>
<ul>
<li>
<p>Describe the target cluster and how to connect to.</p>
</li>
<li>
<p>Define a local location as our template repository.</p>
</li>
<li>
<p>Create the <code>tsup</code> technical account.</p>
</li>
<li>
<p>Create a folder <code>/opt/tsup</code> as an home folder for the application.</p>
</li>
<li>
<p>Create a supervisor instance name <code>tsupv</code>.</p>
</li>
<li>
<p>Copy the <code>program1.sh</code> in the <code>/opt/tsup</code> folder.</p>
</li>
<li>
<p>And declare this program to be managed by the supervisor instance we just defined. </p>
</li>
</ul>
<p>Of course, we will need a test program to manage. Let's write a simple script:</p>
<pre><code class="bash">#!/bin/bash
user=$(id -un)
prg=program1
while true
do 
    echo &quot;$(date -Iseconds) - - - Hello from ${user}:${prg} to stdout.....&quot; 
    sleep 2
done
</code></pre>

<p>And save it as <code>templates/program1.sh</code>.</p>
<p>Our application is now ready to be deployed. On the deployement node (Called <code>deployer</code> here):</p>
<pre><code class="bash">[hadeployer]$ hadeploy --src app.yml --action deploy
</code></pre>

<p>Then, we can log on one edge node and ensure both the daemon and the supervisor run under the <code>tsup</code> account.</p>
<pre><code class="bash">[en1]$ pgrep -au tsup
4392 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord_tsupv.conf
4621 /bin/bash /opt/tsup/program1.sh
7983 sleep 2
</code></pre>

<p>And we can now play with the supervisor command line interface created for our instance (<code>supervisorctl_tsupv</code>), under the <code>tsup</code> account:</p>
<pre><code class="bash">[en1]$ sudo -u tsup supervisorctl_tsupv
program1                         RUNNING   pid 4621, uptime 0:07:03
supervisor&gt; help

default commands (type help &lt;topic&gt;):
=====================================
add    clear  fg        open  quit    remove  restart   start   stop  update
avail  exit   maintail  pid   reload  reread  shutdown  status  tail  version

supervisor&gt; status program1
program1                         RUNNING   pid 4621, uptime 0:07:20
supervisor&gt; tail program1
llo from tsup:program1 to stdout.....
2017-10-15T08:53:28+0000 - - - Hello from tsup:program1 to stdout.....
...
...
2017-10-15T08:54:09+0000 - - - Hello from tsup:program1 to stdout.....
2017-10-15T08:54:11+0000 - - - Hello from tsup:program1 to stdout.....

supervisor&gt; stop program1
program1: stopped
supervisor&gt; status
program1                         STOPPED   Oct 15 08:54 AM
supervisor&gt; start program1
program1: started
supervisor&gt; status
program1                         RUNNING   pid 8270, uptime 0:00:05
supervisor&gt;
</code></pre>

<p>From the HADeploy node, we can stop both the program and the supervisor in one command:</p>
<pre><code class="bash">[hadeployer]$ hadeploy --src app.yml --action stop
</code></pre>

<p>Ensure this is no process running under <code>tsup</code> account on the edge node:</p>
<pre><code class="bash">[en1]$ pgrep -au tsup
</code></pre>

<p>Back to the HADeploy node, restart everything:</p>
<pre><code class="bash">[hadeployer]$ hadeploy --src app.yml --action start
</code></pre>

<p>An check on the edge node:</p>
<pre><code class="bash">[en1]$ pgrep -au tsup
8887 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord_tsupv.conf
8974 /bin/bash /opt/tsup/program1.sh
9046 sleep 2
</code></pre>

<h2 id="actions-stop-start-and-status">Actions <code>stop</code>, <code>start</code> and <code>status</code></h2>
<p>As just mentioned, the <code>Supervisor</code> plugin introduce three new actions:</p>
<pre><code class="sh">hadeploy --src ..... --action stop
</code></pre>

<p>Will stop all <code>supervisor_programs</code> and then all supervisord daemon described by the <code>supervisors</code> list which have the <code>managed</code> flag to <code>true</code>. And: </p>
<pre><code class="sh">hadeploy --src ..... --action start
</code></pre>

<p>Will start the same supervisord daemon, then all <code>supervisor_programs</code>. And:</p>
<pre><code class="sh">hadeploy --src ..... --action status
</code></pre>

<p>Will display current status in a rather primitive form.</p>
<h2 id="web-interface">Web interface</h2>
<p>Each supervisor instance can expose a web interface for management. We can easily configure it by adding a line to our supervisor definition:</p>
<pre><code class="yaml">supervisors:
- name: tsupv 
  scope: all
  user: tsup
  group: tsup
  http_server: { endpoint: &quot;0.0.0.0:9001&quot;, username: admin, password: admin }
</code></pre>

<p>Then, we just neeed to trigger a new deployment:</p>
<pre><code class="bash">[hadeployer]$ hadeploy --src app.yml --action deploy
</code></pre>

<p>If we look at the deployment messages, we can see only two tasks where performed:</p>
<pre><code>TASK [Setup configuration file /etc/supervisord_tsupv.conf] ****************************************************************************************************
changed: [en1]

TASK [Setup supervisord_tsupv.service] *************************************************************************************************************************
ok: [en1]

TASK [Setup /usr/bin/supervisorctl_tsupv] **********************************************************************************************************************
ok: [en1]

RUNNING HANDLER [Restart supervisord_tsupv service] ************************************************************************************************************
changed: [en1]
.....
.....
PLAY RECAP *****************************************************************************************************************************************************
en1                        : ok=19   changed=2    unreachable=0    failed=0
</code></pre>

<ul>
<li>
<p>The supervisor configuration file <code>/etc/supervisord_tsupv.conf</code> has be regenerated, with the http_server configuration.</p>
</li>
<li>
<p>The supervisor <code>supervisord_tsupv</code> has been restarted</p>
</li>
</ul>
<blockquote>
<p><sub>Of course, if we trigger again a deployment no change will be performed anymore.</sub> </p>
</blockquote>
<p>We can now point a browser to <code>http://en1.mycluster.com:9001/</code>, to see:</p>
<p><img alt="Screenshot" src="../../../img/supervisor2.png" /></p>
<p>Of course, in real life, we will not use 'admin' as a password. And we will not provide it as clear text, but provide its SHA-1 form instead. See <a href="../supervisors/#web-interface">Supervisors Web interface</a></p>
<h2 id="notifications-daemon-restart">Notifications: daemon restart</h2>
<p>Let's say we now want to update our <code>program1.sh</code>.</p>
<p>We can modify it and trigger a new deployment. HADeploy will notice the modification and push the new version on the target hosts. But, the running daemon will be unafected.</p>
<p>We can restart it manually. But, HADeploy provide a mechanisme to automate this. By adding a <code>notify</code> attribute to the <a href="../../files/files"><code>files</code></a> definition:</p>
<pre><code class="yaml">files:
- { scope: all, notify: [&quot;supervisor://tsupv/program1&quot;], src: &quot;tmpl://program1.sh&quot;, dest_folder: /opt/tsup, owner: tsup, group: tsup, mode: &quot;0755&quot; }
</code></pre>

<p>This will instruct HADeploy to restart the program <code>program1</code> of the supervisor instance <code>tsupv</code> in case of modification of program1.sh</p>
<pre><code>TASK [Copy template file 'program1.sh' to '/opt/tsup/program1.sh'] *********************************************************************************************
changed: [en1]

TASK [Get current state for supervisor_tsupv_program1 programs] ************************************************************************************************
ok: [en1]

RUNNING HANDLER [Restart supervisor_tsupv program program1] ****************************************************************************************************
changed: [en1]
...
...
PLAY RECAP *****************************************************************************************************************************************************
en1                        : ok=20   changed=2    unreachable=0    failed=0
</code></pre>

<h2 id="non-root-deployment">Non-root deployment</h2>
<p>Creating a supervisor instance needs root access on the target nodes. </p>
<p>Requiring root access for all deployment can be a problem, as it may restrain the number of people able to deploy application. And, an error in the deployment file can corrupt or even destroy the whole target cluster.</p>
<p>A solution to this problem would be to split the deployment in two phases:</p>
<ul>
<li>
<p>An initial deployment, under root access, will create dedicated folders, namespace, databases, ... thus defining a limited space inside which the application will be deployed. Such space can be called 'box', 'container' or 'corridor'.</p>
</li>
<li>
<p>Application deployment, performed under non-priviledged account (Typically the application technical account) and which will be limited to operate in the space defined previously.</p>
</li>
</ul>
<p>In our use case, the supervisor instance creation will be performed during the initial stage, while program1.sh will be deployed under application account.</p>
<p>This will lead to split our application file in two parts:</p>
<p>A first file, named <code>init.yml</code>:</p>
<pre><code class="yaml">hosts:
- { name: en1, ssh_host: en1.mycluster.com, ssh_user: root, ssh_private_key_file: keys/root_id }
- { name: en2, ssh_host: en2.mycluster.com, ssh_user: root, ssh_private_key_file: keys/root_id }

users:
- login: tsup
  authorized_keys:
  - keys/tsup_id.pub

folders:
- { scope: all, path: /opt/tsup, owner: tsup, group: tsup,  mode: &quot;0755&quot; }

supervisors:
- name: tsupv 
  scope: all
  user: tsup
  group: tsup
  http_server: { endpoint: &quot;0.0.0.0:9001&quot;, username: admin, password: admin }
</code></pre>

<p>Let's comment it:</p>
<ul>
<li>
<p>First, as before, we access the target node using the <code>root</code> credential.</p>
</li>
<li>
<p>As before, we create our application technical account. But we had an <code>authorized_key</code> to be able to directly log on under this account. Of course, we have previously generated a key pair.</p>
</li>
<li>
<p>Then, we create the application main folder. Note we need to be root to create a folder in <code>/opt</code>.</p>
</li>
<li>
<p>And we create the supervisor instance as previously.</p>
</li>
</ul>
<p>Now, we will create the application deployment part, as <code>app.yml</code>:</p>
<pre><code class="yaml">hosts:
- { name: en1, ssh_host: en1.mycluster.com, ssh_user: tsup, ssh_private_key_file: keys/tsup_id }
- { name: en2, ssh_host: en2.mycluster.com, ssh_user: tsup, ssh_private_key_file: keys/tsup_id }

local_templates_folders:
- ./templates

files:
- { scope: all, notify: &quot;tsupv:program1&quot;, src: &quot;tmpl://program1.sh&quot;, dest_folder: /opt/tsup, owner: tsup, group: tsup, mode: &quot;0755&quot; }

supervisor_programs:
- name: program1
  supervisor: tsupv
  command: &quot;/bin/bash /opt/tsup/program1.sh&quot;

supervisors:
- name: tsupv 
  scope: all
  user: tsup
  group: tsup
  http_server: { endpoint: &quot;0.0.0.0:9001&quot;, username: admin, password: admin }
  managed: no
</code></pre>

<p>Let's comment it:</p>
<ul>
<li>
<p>We now access the target host with the <code>tsup</code> credential.</p>
</li>
<li>
<p>As before, we define a local location as our template repository.</p>
</li>
<li>
<p>As before, we copy the <code>program1.sh</code> in the <code>/opt/tsup</code> folder. </p>
</li>
<li>
<p>And, as before, we declare this program to be managed by the supervisor instance we defined previously.</p>
</li>
</ul>
<p>But, there is a problem. To perform this last operation, HADeploy need to know most of the parameters of the supervisor (Mostly its file layout). This is why we need to insert the supervisor definition in the file, here at the end.</p>
<p>But, we just want to describe it. We don't want to manage it (This is the role of the <code>init.yml</code> script). This is why we add the <code>managed: no</code> attribute.</p>
<blockquote>
<p><sub>Don't be confused. Managing supervisor's program is not managing the supervisor by itself.</sub></p>
</blockquote>
<p>You can now deploy the application container:</p>
<pre><code class="bash">hadeploy --src init.yml --action deploy
</code></pre>

<p>And then the application by itself:</p>
<pre><code class="bash">hadeploy --src app.yml --action deploy
</code></pre>

<p>This pattern provide other benefits:</p>
<ul>
<li>
<p>Application (re)deployment is faster, as the number of task is reduced.</p>
</li>
<li>
<p>We have now finer control on application stop and start. <code>hadeploy --src app.yml --action stop</code> will only stop the application programs, not the supervisor itself. </p>
</li>
</ul>
<h3 id="root-key-protection">Root key protection</h3>
<p>But, how can we prevent a regular (non-root) user to launch the <code>init.yml</code> script ?</p>
<p>A simple answer is to arrange for the root private key (<code>keys/root_id</code> in our case) to be accessible only by the root user (or by a priviledged users group) on the HADeploy node. 
This is an easy way to bind priviledged access on target cluster to privileged access on the deployment node.</p>
<h2 id="non-root-deployment-improved">Non-root deployment improved</h2>
<p>If you look at the previous <code>init.yml</code> and <code>app.yml</code>, you will find some redundancies:</p>
<ul>
<li>
<p>The host inventory</p>
</li>
<li>
<p>The supervisor definition.</p>
</li>
</ul>
<p>So, we need some refactoring to have something more maintainable:</p>
<p>First, we isolate our target cluster inventory definition in a separate file <code>mycluster.yml</code>:</p>
<pre><code class="yaml">hosts:
- { name: en1, ssh_host: en1.mycluster.com } 
- { name: en2, ssh_host: en2.mycluster.com } 
</code></pre>

<p>Note than we have remove all ssh connection information.</p>
<p>The, we isolate the supervisor(s) definitions in another file <code>supervisors.yml</code>:</p>
<pre><code class="yaml">supervisors:
- name: tsupv 
  scope: all
  user: tsup
  group: tsup
  http_server: { endpoint: &quot;0.0.0.0:9001&quot;, username: admin, password: admin }
  managed: ${managing_supervisors}
</code></pre>

<p>Note than we can set the <code>managed</code> attribute by a variable.</p>
<p>And here is the new version of the <code>init.yml</code>file:</p>
<pre><code class="yaml">host_overrides:
- name: all
  ssh_user: root
  ssh_private_key_file: keys/root_id 

users:
- login: tsup
  authorized_keys:
  - keys/tsup_id.pub

folders:
- { scope: all, path: /opt/tsup, owner: tsup, group: tsup,  mode: &quot;0755&quot; }

vars:
  managing_supervisors: yes

include: supervisors.yml
</code></pre>

<p>And the new version of the <code>app.yml</code> file:</p>
<pre><code class="yaml">host_overrides:
- name: all
  ssh_user: tsup
  ssh_private_key_file: keys/tsup_id 

vars:
  managing_supervisors: no

include: supervisors.yml

local_templates_folders:
- ./templates

files:
- { scope: all, notify: &quot;tsupv:program1&quot;, src: &quot;tmpl://program1.sh&quot;, dest_folder: /opt/tsup, owner: tsup, group: tsup, mode: &quot;0755&quot; }

supervisor_programs:
- name: program1
  supervisor: tsupv
  command: &quot;/bin/bash /opt/tsup/program1.sh&quot;
</code></pre>

<p>We can now proceed with the application container deployment:</p>
<pre><code class="bash">hadeploy --src mycluster.yml --src init.yml --action deploy
</code></pre>

<p>And then the application deployment:</p>
<pre><code class="bash">hadeploy --src mycluster.yml --src app.yml --action deploy
</code></pre>

<p>Note than we provide the <code>mycluster.yml</code> on the command line. An alternative would be to include it in the <code>init.yml</code> and the <code>app.yml</code>. But, if you have several target clusters, this solution is far more flexible.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

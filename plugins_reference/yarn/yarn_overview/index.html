<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>yarn_overview - HADeploy</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../..">HADeploy</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                    <li >
                        <a href="../../../installation/">Installation</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../getting_started/first_step/">First step</a>
</li>
                            
<li >
    <a href="../../../getting_started/next_step/">Next step</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Plugins reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
  <li class="dropdown-submenu">
    <a href="#">Core</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../core/encrypted_vars/">encrypted_vars</a>
</li>
            
<li >
    <a href="../../core/excluded_scopes/">excluded_scopes</a>
</li>
            
<li >
    <a href="../../core/include/">include</a>
</li>
            
<li >
    <a href="../../core/included_scopes/">included_scopes</a>
</li>
            
<li >
    <a href="../../core/vars/">vars</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ansible/ansible_overview/">Overview</a>
</li>
            
<li >
    <a href="../../ansible/ansible_playbooks/">ansible_playbooks</a>
</li>
            
<li >
    <a href="../../ansible/playbooks_folders/">playbooks_folders</a>
</li>
            
<li >
    <a href="../../ansible/roles_folders/">roles_folders</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ansible_inventories</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ansible_inventories/ansible_inventories/">ansible_inventories</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Elasticsearch</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../elastic/elasticsearch_indices/">elasticsearch_indices</a>
</li>
            
<li >
    <a href="../../elastic/elasticsearch_servers/">elasticsearch_servers</a>
</li>
            
<li >
    <a href="../../elastic/elasticsearch_templates/">elasticsearch_templates</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Files</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../files/files/">files</a>
</li>
            
<li >
    <a href="../../files/folders/">folders</a>
</li>
            
<li >
    <a href="../../files/maven_repositories/">maven_repositories</a>
</li>
            
<li >
    <a href="../../files/local_files_folders/">local_files_folders</a>
</li>
            
<li >
    <a href="../../files/local_templates_folders/">local_templates_folders</a>
</li>
            
<li >
    <a href="../../files/trees/">trees</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">HBase</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hbase/hbase_datasets/">hbase_datasets</a>
</li>
            
<li >
    <a href="../../hbase/hbase_namespaces/">hbase_namespaces</a>
</li>
            
<li >
    <a href="../../hbase/hbase_relay/">hbase_relay</a>
</li>
            
<li >
    <a href="../../hbase/hbase_tables/">hbase_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hdfs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hdfs/hdfs_relay/">hdfs_relay</a>
</li>
            
<li >
    <a href="../../hdfs/source_host_credentials/">source_host_credentials</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Hive</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../hive/hive_databases/">hive_databases</a>
</li>
            
<li >
    <a href="../../hive/hive_relay/">hive_relay</a>
</li>
            
<li >
    <a href="../../hive/hive_tables/">hive_tables</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Inventory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../inventory/exit_on_fail/">exit_on_fail</a>
</li>
            
<li >
    <a href="../../inventory/hosts/">hosts</a>
</li>
            
<li >
    <a href="../../inventory/host_groups/">host_groups</a>
</li>
            
<li >
    <a href="../../inventory/host_group_overrides/">host_group_overrides</a>
</li>
            
<li >
    <a href="../../inventory/host_overrides/">host_overrides</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Kafka</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../kafka/kafka_relay/">kafka_relay</a>
</li>
            
<li >
    <a href="../../kafka/kafka_topics/">kafka_topic</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Ranger</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../ranger/hbase_ranger_policies/">hbase_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/hdfs_ranger_policies/">hdfs_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/hive_ranger_policies/">hive_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/kafka_ranger_policies/">kafka_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/ranger_relay/">ranger_relay</a>
</li>
            
<li >
    <a href="../../ranger/storm_ranger_policies/">storm_ranger_policies</a>
</li>
            
<li >
    <a href="../../ranger/yarn_ranger_policies/">yarn_ranger_policies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Storm</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../storm/storm_overview/">storm_overview</a>
</li>
            
<li >
    <a href="../../storm/storm_relay/">storm_relay</a>
</li>
            
<li >
    <a href="../../storm/storm_topologies/">storm_topologies</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Systemd</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../systemd/systemd_units/">systemd_units</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Supervisors</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../supervisor/supervisor_overview/">Overview</a>
</li>
            
<li >
    <a href="../../supervisor/supervisors/">supervisors</a>
</li>
            
<li >
    <a href="../../supervisor/supervisor_groups/">supervisor_groups</a>
</li>
            
<li >
    <a href="../../supervisor/supervisor_programs/">supervisor_programs</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Users</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../users/groups/">groups</a>
</li>
            
<li >
    <a href="../../users/users/">users</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">Yarn</a>
    <ul class="dropdown-menu">
            
<li class="active">
    <a href="./">yarn_overview</a>
</li>
            
<li >
    <a href="../yarn_relay/">yarn_relay</a>
</li>
            
<li >
    <a href="../yarn_services/">yarn_service</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../more/conditional_deployment/">Conditional deployment</a>
</li>
                            
<li >
    <a href="../../../more/under_the_hood/">Under the hood</a>
</li>
                            
<li >
    <a href="../../../more/execution_order/">Execution order</a>
</li>
                            
<li >
    <a href="../../../more/altering_scope/">Altering scope</a>
</li>
                            
<li >
    <a href="../../../more/secured_cluster/">Secured cluster</a>
</li>
                            
<li >
    <a href="../../../more/yaml_tricks/">YAML tricks</a>
</li>
                            
<li >
    <a href="../../../more/release_notes/">Release notes</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../users/users/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../yarn_relay/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#yarn-plugin-overview">Yarn plugin: Overview</a></li>
            <li><a href="#goal">Goal</a></li>
            <li><a href="#how-it-works">How it works</a></li>
            <li><a href="#requirement">Requirement</a></li>
            <li><a href="#yarn-services-deployment">Yarn services deployment.</a></li>
            <li><a href="#actions-stopstart-and-status">Actions stop,start and status</a></li>
            <li><a href="#services-shutdown">Services shutdown.</a></li>
            <li><a href="#notifications-services-restart">Notifications: Services restart</a></li>
            <li><a href="#ranger-support">Ranger support.</a></li>
            <li><a href="#example">Example</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="yarn-plugin-overview">Yarn plugin: Overview</h1>
<h3 id="goal">Goal</h3>
<p>Aim of the Yarn plugin is to handle Yarn services Life cycle</p>
<ul>
<li>
<p>Start Yarn services</p>
</li>
<li>
<p>Stop Yarn services</p>
</li>
<li>
<p>Get current Yarn service status</p>
</li>
</ul>
<p>By 'Yarn services', we mean Yarn jobs running indefinitely, such as Spark Streaming jobs. </p>
<p>This all also named as 'Yarn Long Running Services', or 'Yarn Long Running Jobs'.</p>
<p><strong><em>This plugin is NOT intended to manage Batch jobs.</em></strong></p>
<h3 id="how-it-works">How it works</h3>
<p>This is achieved by:</p>
<ul>
<li>
<p>Issuing command to the Yarn Resource Manager through its REST API</p>
</li>
<li>
<p>Start Yarn service when required using a user provided launching script.</p>
</li>
</ul>
<p>All these operations are performed on a specific node included in the cluster. This node is designated as a <a href="../yarn_relay"><code>yarn_relay</code></a>.</p>
<h3 id="requirement">Requirement</h3>
<p>There is some requirement for the launching script.</p>
<ul>
<li>
<p>HADeploy identify Yarn services by its name. So care must be taken to ensure the service name match the one provided in the definition. 
This can easily be achieved using the <code>--name</code> option on the yarn/spark <code>submit</code> command. See example below.</p>
</li>
<li>
<p>The launching script must exit after launching the job. For Spark, the <code>--conf "spark.yarn.submit.waitAppCompletion=false"</code> option can be used. See example below.</p>
</li>
</ul>
<h2 id="yarn-services-deployment">Yarn services deployment.</h2>
<p>The deployment of each services by itself is NOT in the scope of this plugin. Typically this consist in:</p>
<ul>
<li>
<p>Create a deployment folder.</p>
</li>
<li>
<p>Deploying a jar</p>
</li>
<li>
<p>Deploying one or several configuration files</p>
</li>
<li>
<p>Eventually, deploying a script to launch the service.</p>
</li>
</ul>
<p>This at least on the Yarn relay node and eventually on one or several other nodes, for resiliency. </p>
<p>All these tasks can be achieved using this HADeploy <a href="../../files/folders"><code>folders</code></a> and <a href="../../files/files"><code>files</code></a> specification. </p>
<p>Templating mechanism and support of Maven repository built in the <a href="../../files/files"><code>files</code></a> plugin will be of great help here. </p>
<h2 id="actions-stopstart-and-status">Actions <code>stop</code>,<code>start</code> and <code>status</code></h2>
<p>The <code>yarn</code> plugin introduce three new actions:</p>
<pre><code class="sh">hadeploy --src ..... --action start
</code></pre>

<p>Will start all services described by the <a href="../yarn_services"><code>yarn_services</code></a> list. And </p>
<pre><code class="sh">hadeploy --src ..... --action stop
</code></pre>

<p>Will kill the same services. While </p>
<pre><code class="sh">hadeploy --src ..... --action status
</code></pre>

<p>will display current status of the services, in a rather primitive form.</p>
<p>Also, the Yarn plugin kill all running services at one of the first step of the removal action (<code>--action remove</code>).</p>
<p>Of course, all this will occur only on services HADeploy is aware of (Defined with <a href="../yarn_services"><code>yarn_services</code></a>). Other services will not be impacted.</p>
<h2 id="services-shutdown">Services shutdown.</h2>
<p>When HADeploy is instructed to halt all services (<code>--action stop</code>), by default, it will use the RM REST API, setting application in the 'KILLED' state. This is equivalent to a <code>yarn application --kill</code> command.</p>
<p>An alternate way to shutdown a yarn job is to provide a script issuing the kill command, and to define such script using the <code>killing_cmd</code> attribute. This can be used in the following case: </p>
<ul>
<li>
<p>If your application provide a more graceful shutdown method</p>
</li>
<li>
<p>If your cluster is secured by Kerberos and if the RM REST API is not secured by SPNEGO. In such case, using such API will not allow setting of the appropriate user, and a killing script is a far more easy solution. </p>
</li>
</ul>
<h2 id="notifications-services-restart">Notifications: Services restart</h2>
<p>Let's say we now want to update the service's jar or one of the associated configuration files.</p>
<p>We can modify it and trigger a new deployment. HADeploy will notice the modification and push the new version on the target hosts. But, the running services will be unaffected.</p>
<p>We can restart it manually. But, HADeploy provide a mechanism to automate this. By adding a <code>notify</code> attribute to the <a href="../../files/files"><code>files</code></a> definition. See the example below.</p>
<h2 id="ranger-support">Ranger support.</h2>
<p>Ranger handling on Yarn jobs is based on Yarn Queue management. HADeploy allow you to define such permission using <a href="../../ranger/yarn_ranger_policies/">yarn_ranger_policies</a>.</p>
<h2 id="example">Example</h2>
<p>Here is a snippet describing the deployment of a simple Yarn services 'datastep':</p>
<pre><code class="yaml">
vars:
  yarn_launcher_host: en1
  basedir: &quot;/opt/datastep&quot;
  user: dsrunner
  group: dsrunner
  datastep_version: &quot;0.1.0-SNAPSHOT&quot;

yarn_relay:
  host: ${yarn_launcher_host}

maven_repositories:
- name: myrepo
  snapshots_url: http://myrepo.mydomain.com/nexus/repository/maven-snapshots/
  releases_url: http://myrepo.mydomain.com/nexus/repository/maven-releases/

folders:
- { path: &quot;${basedir}&quot;, scope: &quot;${yarn_launcher_host}&quot;, owner: &quot;${user}&quot;, group: &quot;${group}&quot;, mode: &quot;755&quot; }

files:
- { scope: &quot;${yarn_launcher_host}&quot;, src: &quot;mvn://myrepo/com.mydomain/datastep/${datastep_version}/uber&quot;, 
    notify: ['yarn://datastep'], dest_folder: &quot;${basedir}&quot;, owner: &quot;${user}&quot;, group: &quot;${group}&quot;, mode: &quot;0644&quot; }

- { scope: &quot;${yarn_launcher_host}&quot;, src: &quot;tmpl://submit.sh&quot;, dest_folder: &quot;${basedir}&quot;, 
    notify: ['yarn://datastep'], owner: &quot;${user}&quot;, group: &quot;${group}&quot;, mode: &quot;0744&quot; }

- { scope: &quot;${yarn_launcher_host}&quot;, src: &quot;tmpl://kill.sh&quot;, dest_folder: &quot;${basedir}&quot;, 
    notify: ['yarn://datastep'], owner: &quot;${user}&quot;, group: &quot;${group}&quot;, mode: &quot;0744&quot; }

yarn_services:
- name: datastep
  launching_cmd: ./submit.sh
  launching_cmd: ./kill.sh
  launching_dir: ${basedir}

</code></pre>

<p>And here is what could be a simplistic submit script template:</p>
<pre><code class="bash">#/bin/bash

{% if kerberos is defined and kerberos %}
kinit -kt /etc/security/keytabs/{{user}}.keytab {{user}}
{% endif %}

spark-submit --name datastep --master yarn --deploy-mode cluster --class com.mydomain.datastep.Main \
    --conf &quot;spark.yarn.submit.waitAppCompletion=false&quot; \
    --jars {{basedir}}/datastep-{{datastep_version}}-uber.jar 

{% if kerberos is defined and kerberos %}
kdestroy
{% endif %}

</code></pre>

<p>And a killing script:</p>
<pre><code class="bash">#/bin/bash

{% if kerberos is defined and kerberos %}
kinit -kt /etc/security/keytabs/{{user}}.keytab {{user}}
{% endif %}

APPLICATION_ID=$(yarn application --appStates RUNNING --list 2&gt;/dev/null | awk &quot;{ if (\$2==\&quot;datastep\&quot;) print \$1 }&quot;)

if [ &quot;$APPLICATION_ID&quot; = &quot;&quot; ]
then
    echo &quot;?? Not running&quot;
else
    yarn application --kill ${APPLICATION_ID} 2&gt;/dev/null
    echo &quot;$APPLICATION_ID Killed!&quot;
fi

{% if kerberos is defined and kerberos %}
kdestroy
{% endif %}

</code></pre>

<p>This is of course not complete, as it lack at least the target cluster definition.</p>
<p>Please refer to <a href="../yarn_relay"><code>yarn_relay</code></a> and <a href="../yarn_services"><code>yarn_services</code></a> for a complete description. And to <a href="../../files/files"><code>files</code></a> for the <code>notify</code> syntax.</p>
<p>Of course, before being able to launch the services (<code>--action start</code>), a deployment must be performed before (<code>--action deploy</code>)</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
